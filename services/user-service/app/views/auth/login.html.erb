<% content_for :title, t('auth.login.title', default: 'Sign In') %>

<div class="calm-auth-container" data-controller="unified-auth">
  <div class="calm-auth-card animate-fade-in">
    <!-- Logo and Welcome -->
    <div class="calm-auth-header">
      <div class="calm-auth-logo">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </div>
      <h1 class="calm-auth-title"><%= t('auth.login.welcome_back', default: 'Welcome back') %></h1>
      <p class="calm-auth-subtitle"><%= t('auth.login.subtitle', default: 'Sign in to continue your peaceful journey') %></p>
    </div>

    <!-- Tab Navigation -->
    <div class="calm-tabs" role="tablist">
      <button class="calm-tab active" 
              role="tab"
              aria-selected="true"
              data-unified-auth-target="emailTab"
              data-action="click->unified-auth#switchToEmail">
        <span class="calm-tab-icon">‚úâÔ∏è</span>
        <%= t('auth.login.email_tab', default: 'Email') %>
      </button>
      <button class="calm-tab" 
              role="tab"
              aria-selected="false"
              data-unified-auth-target="phoneTab"
              data-action="click->unified-auth#switchToPhone">
        <span class="calm-tab-icon">üì±</span>
        <%= t('auth.login.phone_tab', default: 'Phone') %>
      </button>
    </div>

    <!-- Email Login Form -->
    <turbo-frame id="email-login" data-unified-auth-target="emailLogin">
      <%= form_with(model: resource, 
                    as: resource_name, 
                    url: session_path(resource_name),
                    data: { 
                      controller: "form-validation",
                      form_validation_realtime_value: true,
                      action: "turbo:submit-end->unified-auth#handleSubmitEnd"
                    }) do |f| %>
        
        <div class="calm-form-group">
          <%= f.label :email, class: "calm-form-label" %>
          <%= f.email_field :email, 
                           autofocus: true, 
                           autocomplete: "email",
                           placeholder: t('auth.login.email_placeholder', default: 'your@email.com'),
                           class: "calm-form-input",
                           data: { 
                             form_validation_target: "field",
                             required: true,
                             email: true,
                             required_message: t('validations.email_required'),
                             email_message: t('validations.email_invalid')
                           },
                           "aria-describedby": "email-error" %>
          <span id="email-error" class="calm-form-error" hidden></span>
        </div>

        <div class="calm-form-group">
          <%= f.label :password, class: "calm-form-label" %>
          <%= f.password_field :password, 
                              autocomplete: "current-password",
                              placeholder: t('auth.login.password_placeholder', default: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'),
                              class: "calm-form-input",
                              data: { 
                                form_validation_target: "field",
                                required: true,
                                min_length: 6,
                                required_message: t('validations.password_required'),
                                min_length_message: t('validations.password_min_length', count: 6)
                              },
                              "aria-describedby": "password-error" %>
          <span id="password-error" class="calm-form-error" hidden></span>
        </div>

        <div class="calm-form-group flex justify-between items-center">
          <% if devise_mapping.rememberable? %>
            <label class="calm-checkbox-label">
              <%= f.check_box :remember_me, class: "calm-checkbox" %>
              <span><%= t('auth.login.remember_me', default: 'Remember me') %></span>
            </label>
          <% end %>
          
          <%= link_to t('auth.login.forgot_password', default: 'Forgot password?'), 
                     new_password_path(resource_name), 
                     class: "calm-link",
                     data: { turbo_frame: "_top" } %>
        </div>

        <div class="calm-form-actions">
          <%= f.submit t('auth.login.sign_in', default: 'Sign in'), 
                      class: "calm-btn calm-btn-primary calm-btn-block calm-btn-lg",
                      data: { form_validation_target: "submit" } %>
        </div>
      <% end %>
    </turbo-frame>

    <!-- Phone Login Form -->
    <turbo-frame id="phone-login" class="hidden" data-unified-auth-target="phoneLogin">
      <div data-unified-auth-target="phoneStep">
        <%= form_with(url: send_otp_path, 
                      data: { 
                        action: "submit->unified-auth#sendOtp",
                        turbo: false 
                      }) do |f| %>
          <div class="calm-form-group">
            <%= f.label :phone, t('auth.login.phone_label', default: 'Phone Number'), class: "calm-form-label" %>
            <div class="calm-phone-input-wrapper">
              <span class="calm-phone-prefix">+91</span>
              <%= f.telephone_field :phone, 
                                   placeholder: t('auth.login.phone_placeholder', default: '9876543210'),
                                   class: "calm-form-input calm-phone-input",
                                   maxlength: 10,
                                   pattern: "[6-9][0-9]{9}",
                                   data: { unified_auth_target: "phoneInput" },
                                   "aria-describedby": "phone-error" %>
            </div>
            <span id="phone-error" class="calm-form-error" data-unified-auth-target="phoneError" hidden></span>
          </div>

          <div class="calm-form-actions">
            <button type="submit" 
                    class="calm-btn calm-btn-primary calm-btn-block calm-btn-lg"
                    data-unified-auth-target="sendOtpBtn">
              <%= t('auth.login.send_otp', default: 'Send OTP') %>
            </button>
          </div>
        <% end %>
      </div>

      <!-- OTP Verification Step -->
      <div class="hidden" data-unified-auth-target="otpStep">
        <div class="calm-otp-header">
          <h3><%= t('auth.login.verify_otp', default: 'Verify OTP') %></h3>
          <p class="calm-text-muted">
            <%= t('auth.login.otp_sent_to', default: 'We sent a code to') %> 
            <span data-unified-auth-target="phoneDisplay"></span>
          </p>
        </div>

        <div class="calm-otp-inputs" data-unified-auth-target="otpContainer">
          <% 6.times do |i| %>
            <input type="text" 
                   maxlength="1" 
                   pattern="[0-9]"
                   class="calm-otp-input"
                   data-unified-auth-target="otp<%= i + 1 %>"
                   aria-label="<%= t('auth.login.otp_digit', digit: i + 1) %>">
          <% end %>
        </div>

        <div class="calm-form-actions">
          <button type="button" 
                  class="calm-btn calm-btn-primary calm-btn-block calm-btn-lg"
                  data-unified-auth-target="verifyOtpBtn"
                  data-action="click->unified-auth#verifyOtp">
            <span data-unified-auth-target="verifyText">
              <%= t('auth.login.verify', default: 'Verify') %>
            </span>
            <span data-unified-auth-target="verifyDisabledText" class="hidden">
              <%= t('auth.login.too_many_attempts', default: 'Too many attempts') %>
            </span>
          </button>

          <div class="calm-otp-footer">
            <button type="button" 
                    class="calm-link"
                    data-unified-auth-target="resendOtpBtn"
                    data-action="click->unified-auth#resendOtp">
              <span data-unified-auth-target="resendText">
                <%= t('auth.login.resend_otp', default: 'Resend OTP') %>
              </span>
              <span data-unified-auth-target="resendTimer" class="hidden">
                <%= t('auth.login.resend_in', default: 'Resend in') %> 
                <span data-unified-auth-target="timerCountdown">60</span>s
              </span>
            </button>
            
            <button type="button" 
                    class="calm-link"
                    data-action="click->unified-auth#backToPhone">
              <%= t('auth.login.change_number', default: 'Change number') %>
            </button>
          </div>
        </div>
      </div>
    </turbo-frame>

    <!-- Additional Links -->
    <div class="calm-auth-footer">
      <p>
        <%= t('auth.login.no_account', default: "Don't have an account?") %>
        <%= link_to t('auth.login.sign_up', default: 'Sign up'), 
                   new_registration_path(resource_name), 
                   class: "calm-link calm-link-primary",
                   data: { turbo_frame: "_top" } %>
      </p>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="calm-loading-overlay hidden" data-unified-auth-target="loadingOverlay">
    <div class="calm-spinner calm-spinner-lg"></div>
  </div>
</div>

<style>
  /* Authentication specific styles */
  .calm-auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
  }
  
  .calm-auth-card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
    width: 100%;
    max-width: 420px;
    padding: 2.5rem;
  }
  
  .calm-auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  
  .calm-auth-logo {
    width: 4rem;
    height: 4rem;
    margin: 0 auto 1.5rem;
    background: var(--calm-gradient-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }
  
  .calm-auth-title {
    font-family: var(--calm-font-serif);
    font-size: 1.875rem;
    color: var(--calm-gray-900);
    margin-bottom: 0.5rem;
  }
  
  .calm-auth-subtitle {
    color: var(--calm-gray-600);
    font-size: 0.875rem;
  }
  
  /* Tabs */
  .calm-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    padding: 0.25rem;
    background: var(--calm-gray-100);
    border-radius: 0.5rem;
  }
  
  .calm-tab {
    flex: 1;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    border-radius: 0.375rem;
    font-weight: 500;
    color: var(--calm-gray-600);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .calm-tab:hover {
    color: var(--calm-gray-800);
  }
  
  .calm-tab.active {
    background: white;
    color: var(--calm-primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .calm-tab-icon {
    font-size: 1.125rem;
  }
  
  /* Phone input */
  .calm-phone-input-wrapper {
    display: flex;
    align-items: center;
    position: relative;
  }
  
  .calm-phone-prefix {
    position: absolute;
    left: 1rem;
    color: var(--calm-gray-600);
    font-weight: 500;
  }
  
  .calm-phone-input {
    padding-left: 3.5rem !important;
  }
  
  /* OTP inputs */
  .calm-otp-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  
  .calm-otp-inputs {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin-bottom: 2rem;
  }
  
  .calm-otp-input {
    width: 3rem;
    height: 3rem;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 600;
    border: 2px solid var(--calm-gray-300);
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }
  
  .calm-otp-input:focus {
    outline: none;
    border-color: var(--calm-primary);
    box-shadow: 0 0 0 3px rgba(91, 143, 185, 0.1);
  }
  
  .calm-otp-input:valid {
    border-color: var(--calm-success);
  }
  
  .calm-otp-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
  }
  
  /* Checkbox */
  .calm-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--calm-gray-700);
  }
  
  .calm-checkbox {
    width: 1.125rem;
    height: 1.125rem;
    border-radius: 0.25rem;
    border: 2px solid var(--calm-gray-300);
    cursor: pointer;
  }
  
  .calm-checkbox:checked {
    background-color: var(--calm-primary);
    border-color: var(--calm-primary);
  }
  
  /* Links */
  .calm-link {
    color: var(--calm-primary);
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.2s ease;
    background: none;
    border: none;
    cursor: pointer;
  }
  
  .calm-link:hover {
    color: var(--calm-primary-dark);
    text-decoration: underline;
  }
  
  .calm-link-primary {
    font-weight: 600;
  }
  
  /* Footer */
  .calm-auth-footer {
    text-align: center;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--calm-gray-200);
    font-size: 0.875rem;
    color: var(--calm-gray-600);
  }
  
  /* Loading overlay */
  .calm-loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  
  .calm-spinner-lg {
    width: 3rem;
    height: 3rem;
    border-width: 3px;
  }
  
  /* Mobile responsive */
  @media (max-width: 480px) {
    .calm-auth-card {
      padding: 1.5rem;
    }
    
    .calm-auth-title {
      font-size: 1.5rem;
    }
    
    .calm-tab {
      padding: 0.625rem 0.75rem;
      font-size: 0.875rem;
    }
    
    .calm-tab-icon {
      font-size: 1rem;
    }
    
    .calm-otp-input {
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.25rem;
    }
  }
</style>